<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrument Testing Plot</title>
    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- SheetJS CDN for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        #plot {
            width: 100%;
            height: 700px;
            margin-top: 20px;
        }
        .instructions {
            font-size: 14px;
            color: #888;
            margin-top: 20px;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
        .input-section {
            margin-bottom: 20px;
        }
        input[type="file"], select {
            margin: 5px;
            padding: 5px;
        }
        button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Instrument Testing Plot</h1>
        <div class="description">
            Upload an Excel file and select a sheet to plot. Choose a comparison set.
            Use the mouse to zoom, drag to pan, or use the range slider and buttons.
        </div>
        <div class="input-section">
            <input type="file" id="excelFile" accept=".xlsx" onchange="populateSheetOptions()">
            <select id="sheetSelect" disabled>
                <option value="">Select a sheet...</option>
            </select>
            <select id="comparisonSelect" disabled>
                <option value="">Select comparison...</option>
                <option value="RH_New vs RH_old">RH_New vs RH_old</option>
                <option value="RH_New vs Hygro_New">RH_New vs Hygro_New</option>
                <option value="RH_New vs Hygro_old">RH_New vs Hygro_old</option>
                <option value="RH_old vs Hygro_New">RH_old vs Hygro_New</option>
                <option value="RH_old vs Hygro_old">RH_old vs Hygro_old</option>
                <option value="Hygro_New vs Hygro_old">Hygro_New vs Hygro_old</option>
            </select>
            <button id="loadAndPlot" disabled>Load and Plot</button>
        </div>
        <div id="plot"></div>
        <div class="instructions">
            Zoom: Click and drag or use the mouse wheel. | Range Slider: Adjust below the plot. | Buttons: Select "Last 100", "Last 500", or "All".
            <br><span class="error-message" id="errorMessage"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');

            // Function to populate sheet options
            window.populateSheetOptions = function() {
                console.log('populating sheet options');
                alert('Populating sheet options...');
                const fileInput = document.getElementById('excelFile');
                const sheetSelect = document.getElementById('sheetSelect');
                const loadButton = document.getElementById('loadAndPlot');
                const comparisonSelect = document.getElementById('comparisonSelect');
                const errorMessage = document.getElementById('errorMessage');

                if (!fileInput.files.length) {
                    sheetSelect.disabled = true;
                    loadButton.disabled = true;
                    comparisonSelect.disabled = true;
                    sheetSelect.innerHTML = '<option value="">Select a sheet...</option>';
                    errorMessage.textContent = '';
                    console.log('No file selected');
                    alert('No file selected');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    console.log('File loaded, parsing workbook');
                    alert('File loaded, parsing workbook...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    sheetSelect.innerHTML = '<option value="">Select a sheet...</option>';
                    workbook.SheetNames.forEach(sheet => {
                        const option = document.createElement('option');
                        option.value = sheet;
                        option.textContent = sheet;
                        sheetSelect.appendChild(option);
                    });
                    sheetSelect.disabled = false;
                    comparisonSelect.disabled = false;
                    loadButton.disabled = false;
                    errorMessage.textContent = '';
                    console.log('Sheets populated:', workbook.SheetNames);
                    alert('Sheets populated: ' + workbook.SheetNames.join(', '));
                };

                reader.onerror = function() {
                    errorMessage.textContent = 'Error reading the Excel file.';
                    console.error('File read error');
                    alert('Error reading the Excel file');
                    sheetSelect.disabled = true;
                    loadButton.disabled = true;
                    comparisonSelect.disabled = true;
                    sheetSelect.innerHTML = '<option value="">Select a sheet...</option>';
                };

                reader.readAsArrayBuffer(file);
            };

            // Function to load Excel file and plot
            const loadAndPlotButton = document.getElementById('loadAndPlot');
            loadAndPlotButton.addEventListener('click', function() {
                console.log('Load and Plot button clicked');
                alert('Load and Plot button clicked');
                const fileInput = document.getElementById('excelFile');
                const sheetSelect = document.getElementById('sheetSelect');
                const comparisonSelect = document.getElementById('comparisonSelect');
                const errorMessage = document.getElementById('errorMessage');

                if (!fileInput.files.length) {
                    errorMessage.textContent = 'Please upload an Excel file.';
                    console.log('No file uploaded');
                    alert('Please upload an Excel file');
                    return;
                }
                if (!sheetSelect.value) {
                    errorMessage.textContent = 'Please select a sheet.';
                    console.log('No sheet selected');
                    alert('Please select a sheet');
                    return;
                }
                if (!comparisonSelect.value) {
                    errorMessage.textContent = 'Please select a comparison.';
                    console.log('No comparison selected');
                    alert('Please select a comparison');
                    return;
                }

                const file = fileInput.files[0];
                const sheetName = sheetSelect.value;
                const comparison = comparisonSelect.value;
                const reader = new FileReader();

                reader.onload = function(e) {
                    console.log('Processing file for sheet:', sheetName);
                    alert('Processing file for sheet: ' + sheetName);
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: true });

                    // Skip header row (row 5) and take data from row 6 onwards
                    const headerRow = jsonData[5]; // Row 5 is the header row (0-based index 5)
                    const dataRows = jsonData.slice(6); // Row 6 onwards (0-based index 6)

                    if (!headerRow || headerRow.length < 6) { // Ensure enough columns (F is index 5)
                        errorMessage.textContent = 'Invalid data: Missing headers in row 5 or insufficient columns.';
                        console.log('Invalid header row:', headerRow);
                        alert('Invalid data: Missing headers in row 5 or insufficient columns');
                        return;
                    }

                    const colC = dataRows.map(row => (row[2] !== null ? Number(row[2]) : null)); // RH_New
                    const colD = dataRows.map(row => (row[3] !== null ? Number(row[3]) : null)); // RH_old
                    const colE = dataRows.map(row => (row[4] !== null ? Number(row[4]) : null)); // Hygro_New
                    const colF = dataRows.map(row => (row[5] !== null ? Number(row[5]) : null)); // Hygro_old

                    // Filter out null values and ensure matching lengths
                    const validIndices = colC.map((_, i) => colC[i] !== null && colD[i] !== null && colE[i] !== null && colF[i] !== null &&
                                                    !isNaN(colC[i]) && !isNaN(colD[i]) && !isNaN(colE[i]) && !isNaN(colF[i]));
                    const filteredColC = colC.filter((_, i) => validIndices[i]);
                    const filteredColD = colD.filter((_, i) => validIndices[i]);
                    const filteredColE = colE.filter((_, i) => validIndices[i]);
                    const filteredColF = colF.filter((_, i) => validIndices[i]);

                    if (filteredColC.length === 0 || filteredColD.length === 0 || filteredColE.length === 0 || filteredColF.length === 0) {
                        errorMessage.textContent = 'No valid data found in the selected sheet.';
                        console.log('No valid data:', filteredColC, filteredColD, filteredColE, filteredColF);
                        alert('No valid data found in the selected sheet');
                        return;
                    }

                    // Apply clamping after filtering for plotting, but use raw data for correlation
                    const clampedColC = filteredColC.map(v => Math.min(100, Math.max(0, v)));
                    const clampedColD = filteredColD.map(v => Math.min(100, Math.max(0, v)));
                    const clampedColE = filteredColE.map(v => Math.min(100, Math.max(0, v)));
                    const clampedColF = filteredColF.map(v => Math.min(100, Math.max(0, v)));

                    const plotData = { colC: clampedColC, colD: clampedColD, colE: clampedColE, colF: clampedColF };
                    renderPlot(plotData, { colC: filteredColC, colD: filteredColD, colE: filteredColE, colF: filteredColF }, comparison, sheetName);
                    errorMessage.textContent = ''; // Clear error message on success
                    console.log('Plot rendered successfully');
                    alert('Plot rendered successfully');
                };

                reader.onerror = function() {
                    errorMessage.textContent = 'Error reading the Excel file.';
                    console.error('File read error');
                    alert('Error reading the Excel file');
                };

                reader.readAsArrayBuffer(file);
            });

            // Function to process data and render plot
            function renderPlot(plotData, rawData, comparison, sheetName) {
                console.log('Rendering plot with data:', plotData, 'raw data for correlation:', rawData, 'comparison:', comparison, 'sheet:', sheetName);
                alert('Rendering plot...');
                const x = Array.from({ length: plotData.colC.length }, (_, i) => i + 1);

                // Derive title based on selected comparison
                const plotTitle = `${sheetName} - ${comparison}`;

                // Map comparison to specific columns and labels
                let col1_data, col2_data, col1_label, col2_label, rawCol1, rawCol2;
                switch (comparison) {
                    case 'RH_New vs RH_old':
                        col1_data = plotData.colC;
                        col2_data = plotData.colD;
                        col1_label = 'RH_New';
                        col2_label = 'RH_old';
                        rawCol1 = rawData.colC;
                        rawCol2 = rawData.colD;
                        console.log('Plotting RH_New (C) vs RH_old (D)');
                        break;
                    case 'RH_New vs Hygro_New':
                        col1_data = plotData.colC;
                        col2_data = plotData.colE;
                        col1_label = 'RH_New';
                        col2_label = 'Hygro_New';
                        rawCol1 = rawData.colC;
                        rawCol2 = rawData.colE;
                        console.log('Plotting RH_New (C) vs Hygro_New (E)');
                        break;
                    case 'RH_New vs Hygro_old':
                        col1_data = plotData.colC;
                        col2_data = plotData.colF;
                        col1_label = 'RH_New';
                        col2_label = 'Hygro_old';
                        rawCol1 = rawData.colC;
                        rawCol2 = rawData.colF;
                        console.log('Plotting RH_New (C) vs Hygro_old (F)');
                        break;
                    case 'RH_old vs Hygro_New':
                        col1_data = plotData.colD;
                        col2_data = plotData.colE;
                        col1_label = 'RH_old';
                        col2_label = 'Hygro_New';
                        rawCol1 = rawData.colD;
                        rawCol2 = rawData.colE;
                        console.log('Plotting RH_old (D) vs Hygro_New (E)');
                        break;
                    case 'RH_old vs Hygro_old':
                        col1_data = plotData.colD;
                        col2_data = plotData.colF;
                        col1_label = 'RH_old';
                        col2_label = 'Hygro_old';
                        rawCol1 = rawData.colD;
                        rawCol2 = rawData.colF;
                        console.log('Plotting RH_old (D) vs Hygro_old (F)');
                        break;
                    case 'Hygro_New vs Hygro_old':
                        col1_data = plotData.colE;
                        col2_data = plotData.colF;
                        col1_label = 'Hygro_New';
                        col2_label = 'Hygro_old';
                        rawCol1 = rawData.colE;
                        rawCol2 = rawData.colF;
                        console.log('Plotting Hygro_New (E) vs Hygro_old (F)');
                        break;
                    default:
                        errorMessage.textContent = 'Invalid comparison selected.';
                        console.error('Unknown comparison:', comparison);
                        alert('Invalid comparison selected.');
                        return;
                }

                // Validate data existence
                if (!col1_data || !col2_data || col1_data.length !== col2_data.length) {
                    errorMessage.textContent = 'Data mismatch or invalid data for selected comparison.';
                    console.error('Data validation failed:', { col1_data, col2_data });
                    alert('Data mismatch or invalid data for selected comparison.');
                    return;
                }

                // Compute R^2 to match Excel (based on Pearson correlation)
                function calculateRSquared(arr1, arr2) {
                    // Create pairs and filter out invalid entries (NaN or undefined)
                    const validPairs = arr1.map((v, i) => [v, arr2[i]]).filter(pair => typeof pair[0] === 'number' && typeof pair[1] === 'number' && !isNaN(pair[0]) && !isNaN(pair[1]));
                    if (validPairs.length < 2) {
                        console.log('Insufficient valid pairs for R^2:', validPairs.length);
                        return 0;
                    }

                    const n = validPairs.length;
                    const arr1Valid = validPairs.map(pair => pair[0]);
                    const arr2Valid = validPairs.map(pair => pair[1]);

                    const mean1 = arr1Valid.reduce((a, b) => a + b, 0) / n;
                    const mean2 = arr2Valid.reduce((a, b) => a + b, 0) / n;
                    let cov = 0, var1 = 0, var2 = 0;

                    for (let i = 0; i < n; i++) {
                        const dev1 = arr1Valid[i] - mean1;
                        const dev2 = arr2Valid[i] - mean2;
                        cov += dev1 * dev2;
                        var1 += dev1 * dev1;
                        var2 += dev2 * dev2;
                    }

                    const stdDev1 = Math.sqrt(var1 / n); // Population standard deviation
                    const stdDev2 = Math.sqrt(var2 / n); // Population standard deviation

                    console.log('Debug - n:', n, 'Means:', { mean1, mean2 }, 'Covariance:', cov / n, 'StdDev1:', stdDev1, 'StdDev2:', stdDev2, 'Raw data sample:', arr1Valid.slice(0, 5), arr2Valid.slice(0, 5));

                    if (stdDev1 === 0 || stdDev2 === 0) {
                        console.log('Zero variance detected, R^2 set to 0');
                        return 0;
                    }

                    const r = (cov / n) / (stdDev1 * stdDev2); // Pearson correlation
                    const rSquared = r * r; // R^2
                    return Number(rSquared.toFixed(4)); // Match Excel precision
                }

                // Calculate R^2 for the selected pair using raw data
                const r_squared = calculateRSquared(rawCol1, rawCol2);
                console.log('Calculated R^2:', r_squared);
                alert('R^2: ' + r_squared);

                // Compute differences for the selected pair (using clamped data for display)
                const diffs = col1_data.map((v, i) => Math.abs(v - col2_data[i]));
                const total_records = diffs.length;
                const counts = [
                    diffs.filter(d => d === 0).length,
                    diffs.filter(d => d >= 1 && d <= 5).length,
                    diffs.filter(d => d >= 6 && d <= 10).length,
                    diffs.filter(d => d >= 11 && d <= 15).length,
                    diffs.filter(d => d > 15).length
                ];
                const percentages = counts.map(c => `${(c / total_records * 100).toFixed(1)}%`);
                const labels = ["Diff=0%", "1% ≤ Diff ≤ 5%", "6% ≤ Diff ≤ 10%", "11% ≤ Diff ≤ 15%", "Diff > 15%"];
                const table_values = counts.map((c, i) => `${c} (${percentages[i]})`);
                const colors = ['green', 'yellow', 'lightcoral', 'red', 'darkred'];

                // Create summary text for the selected comparison
                const summaryText = `R^2: ${r_squared}<br>` +
                                   `Diff=0%: ${counts[0]} (${percentages[0]})<br>` +
                                   `1% ≤ Diff ≤ 5%: ${counts[1]} (${percentages[1]})<br>` +
                                   `6% ≤ Diff ≤ 10%: ${counts[2]} (${percentages[2]})<br>` +
                                   `11% ≤ Diff ≤ 15%: ${counts[3]} (${percentages[3]})<br>` +
                                   `Diff > 15%: ${counts[4]} (${percentages[4]})`;

                // Create Plotly figure with the selected comparison
                const traces = [
                    {
                        x: x,
                        y: col1_data,
                        mode: 'lines',
                        name: col1_label,
                        line: { width: 2, color: 'blue', shape: 'spline' }
                    },
                    {
                        x: x,
                        y: col2_data,
                        mode: 'lines',
                        name: col2_label,
                        line: { width: 2, color: 'orange', shape: 'spline' }
                    },
                    {
                        type: 'table',
                        header: {
                            values: labels,
                            fill: { color: colors },
                            font: { color: 'white', size: 12 },
                            align: 'center'
                        },
                        cells: {
                            values: [table_values],
                            fill: { color: 'lightgrey' },
                            font: { color: 'black', size: 12 },
                            align: 'center'
                        },
                        domain: { x: [0, 1], y: [0, 0.2] }
                    }
                ];

                const layout = {
                    title: { text: plotTitle, x: 0.5, xanchor: 'center' },
                    xaxis: { title: 'Observation Number(Hours,Days)', rangeslider: { visible: true }, rangeselector: { buttons: [{ count: 100, label: 'Last 100', step: 'all', stepmode: 'backward' }, { count: 500, label: 'Last 500', step: 'all', stepmode: 'backward' }, { step: 'all', label: 'All' }] }, zoom: true },
                    yaxis: { title: 'Humidity(%)', domain: [0.25, 1], range: [0, 100], zoom: true },
                    hovermode: 'x unified',
                    template: 'plotly_white',
                    width: 1000,
                    height: 700,
                    dragmode: 'zoom',
                    showlegend: true,
                    annotations: [{ text: summaryText, xref: 'paper', yref: 'paper', x: 0.5, y: 1.05, showarrow: false, font: { size: 12, color: 'black', family: 'Arial', weight: 'bold' }, bgcolor: 'rgba(255, 255, 255, 0.8)', bordercolor: 'gray', borderwidth: 1, borderpad: 10, align: 'center' }]
                };

                try {
                    Plotly.newPlot('plot', traces, layout);
                } catch (error) {
                    console.error('Error rendering plot:', error);
                    document.getElementById('plot').innerHTML = '<p class="error-message">Error rendering plot. Please check the console for details.</p>';
                    alert('Error rendering plot: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>